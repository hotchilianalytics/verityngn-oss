name: CI

# CI uses conda/mamba instead of pip because:
# 1. Complex dependency resolution (Google Cloud packages, LangChain ecosystem)
# 2. System dependencies (ffmpeg) managed by conda
# 3. Matches production Docker build process (Dockerfile.api, Dockerfile.batch)
# 4. Prevents dependency conflicts that pip cannot resolve
#
# To test CI locally:
#   1. Install miniconda/mambaforge: https://github.com/conda-forge/miniforge
#   2. Run: bash scripts/ci/setup_conda_env.sh
#   3. Run: python test/unit/test_imports.py
#
# To update dependencies:
#   Edit environment-minimal.yml (not requirements.txt for CI)

on:
  pull_request:
  push:
    branches: [main]

jobs:
  ui-smoke:
    name: UI smoke (compile)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Setup conda with mamba (faster solver)
      - uses: conda-incubator/setup-miniconda@v3
        with:
          miniconda-version: "latest"
          python-version: "3.12"
          mamba-version: "*"
          channels: conda-forge,defaults
          channel-priority: strict
          use-only-tar-bz2: true
          auto-update-conda: true
          auto-activate-base: false
      
      # Cache conda environment for faster CI runs
      - name: Cache conda environment
        uses: actions/cache@v4
        with:
          path: ~/.conda/envs/verityngn
          key: conda-env-${{ runner.os }}-${{ hashFiles('environment-minimal.yml') }}
          restore-keys: |
            conda-env-${{ runner.os }}-
      
      # Create conda environment from environment-minimal.yml
      - name: Create conda environment
        shell: bash -l {0}
        run: |
          mamba env create -f environment-minimal.yml --quiet || \
          mamba env update -f environment-minimal.yml --name verityngn --quiet
          mamba clean -afy
      
      # Install streamlit for UI compilation (not in environment-minimal.yml)
      - name: Install streamlit for UI
        shell: bash -l {0}
        run: |
          conda activate verityngn
          pip install streamlit>=1.28.0 --quiet
      
      # Compile UI code
      - name: Compile UI
        shell: bash -l {0}
        run: |
          conda activate verityngn
          python -m compileall -q ui

  core-smoke:
    name: Core smoke (compile + imports)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Setup conda with mamba (faster solver)
      - uses: conda-incubator/setup-miniconda@v3
        with:
          miniconda-version: "latest"
          python-version: "3.12"
          mamba-version: "*"
          channels: conda-forge,defaults
          channel-priority: strict
          use-only-tar-bz2: true
          auto-update-conda: true
          auto-activate-base: false
      
      # Cache conda environment for faster CI runs
      - name: Cache conda environment
        uses: actions/cache@v4
        with:
          path: ~/.conda/envs/verityngn
          key: conda-env-${{ runner.os }}-${{ hashFiles('environment-minimal.yml') }}
          restore-keys: |
            conda-env-${{ runner.os }}-
      
      # Create conda environment from environment-minimal.yml
      - name: Create conda environment
        shell: bash -l {0}
        run: |
          mamba env create -f environment-minimal.yml --quiet || \
          mamba env update -f environment-minimal.yml --name verityngn --quiet
          mamba clean -afy
      
      # Compile core code
      - name: Compile core
        shell: bash -l {0}
        run: |
          conda activate verityngn
          python -m compileall -q verityngn
      
      # Run import smoke tests
      - name: Import smoke
        shell: bash -l {0}
        run: |
          conda activate verityngn
          python test/unit/test_imports.py

  secret-scan:
    name: Secret scan (regex)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      # Secret scan only needs Python stdlib, no dependencies
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Scan for secrets
        run: |
          python scripts/ci/secret_scan.py


